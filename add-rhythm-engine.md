# Add a rhythm engine

## Architecture

![](.gitbook/assets/rhythmpluginsarchitecture.png)

The main APIs you'll be using are found in the `Rhythm` and `RhythmMusicGeneration` modules:

* [RhythmProvider](https://github.com/jjazzboss/JJazzLab-X/blob/master/Rhythm/src/org/jjazz/rhythm/spi/RhythmProvider.java)  

  Give JJazzLab-X access to one or more `Rhythm` objects provided by your engine

* [Rhythm](https://github.com/jjazzboss/JJazzLab-X/blob/master/Rhythm/src/org/jjazz/rhythm/api/Rhythm.java)  

  The main interface which provides descriptive information about the rhythm, with its `RhythmVoices`, and `hythmParameters`. 

* [MusicGenerator](https://github.com/jjazzboss/JJazzLab-X/blob/master/RhythmMusicGeneration/src/org/jjazz/rhythmmusicgeneration/spi/MusicGenerator.java) A Rhythm implementation should implement the `MusicGenerator` interface to be able to generate music
* [RhythmVoice](https://github.com/jjazzboss/JJazzLab-X/blob/master/Rhythm/src/org/jjazz/rhythm/api/RhythmVoice.java)  

  There is one `RhythmVoice` for each track generated by your rhythm, e.g. "Drums", "Bass", "Piano"

* [RhythmParameter](https://github.com/jjazzboss/JJazzLab-X/tree/master/Rhythm/src/org/jjazz/rhythm/api)  

  The parameters to modulate the rhythm, e.g. "Complexity" or "Fill"

* [MusicGenerator](https://github.com/jjazzboss/JJazzLab-X/blob/master/RhythmMusicGeneration/src/org/jjazz/rhythmmusicgeneration/spi/MusicGenerator.java)   

  The algorithmic engine which generates, for a given song and a given rhythm, the music of your rhythm

## Main interfaces

### `RhythmProvider` 

Basically you need to create your own module which provides an implementation of the `RhythmProvider` interface defined in the Rhythm module.

Your implementation must use the `@ServiceProvider` annotation so that the `RhythmDatabase` instance can automatically find it upon startup. The general Netbeans mechanism used is described [here](http://wiki.netbeans.org/DevFaqLookupDefault).

When user needs to pick up a rhythm, the rhythm selection dialog shows the available `RhythmProvider` instances \(e.g. "Yamaha style based generator"\) and their list of rhythms \(e.g. "jazz", "pop", ...\).

The `RhythmProvider` implementation is responsible to provide:

* An `Info` object \(name, description, author, version, uniqueId\) 
* The list of built-in `Rhythm` objects provided by this implementation 
* The list of file-based `Rhythm` objects provided by this implementation
* An optional settings dialog to tune the rhythm generation engine

**Example**: See [RhythmStubProviderImpl.java](https://github.com/jjazzboss/JJazzLab-X/blob/master/RhythmStubs/src/org/jjazz/rhythm/stubs/RhythmStubProviderImpl.java) for a simple `RhythmProvider` implementation example.

### `Rhythm` 

A `Rhythm` object describes... a rhythm !

* name, for example "samba-fast"
* description
* time signature
* preferred tempo
* feel : ternary/binary 
* etc...

It also defines the `RhythmVoices`, `RhythmParameters`, and a `MusicGenerator`.

**Example**: See [RhythmStub.java](https://github.com/jjazzboss/JJazzLab-X/blob/master/RhythmStubs/src/org/jjazz/rhythm/stubs/RhythmStub.java) for a very simple `Rhythm` implementation example.

### `RhythmVoice` 

There is one `RhythmVoice` for each track generated by this rhythm, e.g. "Drums", "Bass", "Piano". The `RhythmVoice`provides the recommended Midi instrument and settings for the track.

The `RhythmVoices` information is used for example by the Mix Console to display the relevant tracks.

### `RhythmParameter` 

Examples of `RhythmParameters` are "Variation", "Fill", or "Complexity".

The `RhythmParameters` are the _control knobs_ given to the user so he can modulate the rhythm for each song part. You see them in the Song Structure Editor, for each Song Part.

There are ready-to-use classes to quickly define your `RhythmParameters` depending on their type \(a boolean value, one value amongst a set of values, etc\). When these classes are used the framework will automatically show the relevant UI widget in the Song Structure Editor. You can also define your own UI widgets if you prefer.

### `MusicGenerator` 

The object that generates your rhythm music is a `MusicGenerator`. It has just a single method which takes the music generation context as a parameter, and returns the musical phrases \(one per track\) that make the backing track.

There is no public method to directly retrieve the `MusicGenerator` instance from a `Rhythm`. Instead the `MusicGenerator` instance must be put in the _lookup_ of the Rhythm object. This allows for more flexibility than a fixed API: music generation capabilities of a `Rhythm` can change across versions and can be evaluated at runtime by the framework. The general Netbeans lookup mechanism used is described [here](http://wiki.netbeans.org/DevFaqLookup).

When user presses the Play button for a given song, JJazzLab-X will:

* prepare the [MusicGenerationContext](https://github.com/jjazzboss/JJazzLab-X/blob/master/RhythmMusicGeneration/src/org/jjazz/rhythmmusicgeneration/MusicGenerationContext.java) \(e.g. mainly a [Song](https://github.com/jjazzboss/JJazzLab-X/blob/master/Song/src/org/jjazz/song/api/Song.java) object which contains a [ChordLeadSheet](https://github.com/jjazzboss/JJazzLab-X/blob/master/ChordLeadSheet/src/org/jjazz/leadsheet/chordleadsheet/api/ChordLeadSheet.java) and a [SongStructure](https://github.com/jjazzboss/JJazzLab-X/blob/master/SongStructure/src/org/jjazz/songstructure/api/SongStructure.java)\)
* retrieve the `MusicGenerator` implementation from the lookup of the selected `Rhythm`
* pass it the context data and ask it to generate the backing track
* wait until the `MusicGenerator` has finished the music generation
* convert the received music data into a Midi sequence
* play the sequence.

So the `MusicGenerator` is really where the heavy stuff will be done by your engine. There is no synchronization constraint since JJazzLab-X will simply block until music generation is complete.

Note that you can use any technology to perform the generation, including non-Java ones. Only the lightweight API that connects to JJazzLab-X needs to be in Java.

**Example**: See [DummyGenerator.java](https://github.com/jjazzboss/JJazzLab-X/blob/master/RhythmMusicGeneration/src/org/jjazz/rhythmmusicgeneration/DummyGenerator.java) for a very simple `MusicGenerator` implementation example.

